#include <ESP8266WiFi.h>
#include <ESP8266WebServer.h>
#include <ArduinoJson.h>
#include <SPI.h>
#include <IRremoteESP8266.h>
#include <IRrecv.h>
#include <IRutils.h>
#include <IRsend.h>
#include <map>
#include <ESP8266WiFiMulti.h>
#include <ESP8266HTTPClient.h>
#include <WiFiClient.h>

#define RECV_PIN 14
#define IR_LED 12

#include "ServerMgr.h"
#include "TimerMgr.h"

ServerMgr* m_server;
TimerMgr* m_timer;

IRrecv irrecv(RECV_PIN);
IRsend irsend(IR_LED);
bool m_bSend = false;
bool m_bReadFromSerial = true;

StaticJsonBuffer<200> jsonBuffer;

decode_results results;

// Remote Codes - UNR1
uint16_t BTN_NUM_1[67] = {9038, 4514,  574, 564,  568, 1688,  576, 1688,  568, 560,  566, 564,  568, 564,  566, 564,  566, 1692,  568, 1692,  572, 1692,  568, 1686,  574, 1690,  568, 562,  570, 1690,  568, 564,  568, 562,  566, 564,  568, 1692,  568, 564,  568, 564,  562, 566,  568, 562,  568, 562,  566, 564,  566, 1692,  568, 566,  564, 1688,  570, 1692,  572, 1688,  566, 1692,  570, 1690,  568, 1680,  568};  // NEC 61F440BF
uint16_t BTN_NUM_2[67] = {9032, 4518,  578, 554,  574, 1686,  574, 1686,  574, 558,  572, 556,  576, 554,  574, 556,  572, 1686,  576, 1684,  574, 1684,  578, 1684,  572, 1688,  576, 554,  572, 1688,  574, 556,  572, 558,  572, 1686,  574, 1686,  574, 556,  572, 556,  572, 1688,  574, 556,  574, 556,  572, 558,  574, 556,  574, 554,  572, 1688,  572, 1688,  574, 554,  576, 1684,  572, 1686,  574, 1672,  576};  // NEC 61F4C837
uint16_t BTN_NUM_3[67] = {9032, 4516,  576, 560,  570, 1686,  570, 1690,  568, 564,  570, 560,  570, 562,  566, 562,  572, 1686,  570, 1690,  570, 1688,  570, 1688,  568, 1692,  570, 560,  570, 1690,  570, 562,  566, 564,  568, 560,  568, 562,  566, 1692,  570, 1688,  568, 564,  568, 562,  570, 560,  566, 562,  570, 1686,  572, 1686,  570, 562,  568, 562,  570, 1688,  566, 1692,  572, 1686,  572, 1676,  572};  // NEC 61F430CF
uint16_t BTN_NUM_4[67] = {9034, 4518,  574, 560,  570, 1690,  574, 1688,  570, 564,  568, 562,  572, 560,  570, 560,  570, 1688,  570, 1690,  570, 1690,  572, 1688,  572, 1690,  572, 560,  570, 1690,  568, 564,  570, 560,  574, 556,  568, 1688,  570, 1694,  568, 564,  568, 1690,  572, 562,  568, 564,  574, 556,  566, 1692,  570, 562,  568, 562,  570, 1688,  570, 562,  572, 1688,  568, 1690,  570, 1678,  574};  // NEC 61F46897
uint16_t BTN_NUM_5[67] = {9046, 4518,  576, 556,  568, 1690,  568, 1692,  574, 558,  572, 556,  568, 562,  568, 560,  572, 1686,  570, 1688,  572, 1688,  570, 1688,  570, 1690,  576, 554,  570, 1690,  570, 560,  568, 560,  570, 562,  568, 562,  568, 1690,  578, 552,  570, 1690,  578, 554,  570, 560,  574, 552,  570, 1688,  574, 1688,  576, 556,  568, 1690,  570, 560,  572, 1686,  572, 1688,  572, 1676,  574};  // NEC 61F428D7
uint16_t BTN_NUM_6[67] = {9030, 4518,  574, 556,  568, 1690,  576, 1686,  570, 560,  572, 558,  570, 560,  570, 560,  570, 1690,  572, 1688,  572, 1688,  572, 1686,  572, 1688,  572, 556,  574, 1688,  572, 558,  570, 558,  572, 1688,  574, 1684,  572, 1688,  576, 552,  572, 1690,  574, 556,  568, 562,  572, 556,  570, 560,  570, 560,  568, 560,  568, 1690,  572, 558,  570, 1688,  572, 1688,  574, 1672,  572};  // NEC 61F4E817
uint16_t BTN_NUM_7[67] = {9048, 4524,  574, 556,  570, 1688,  574, 1686,  574, 556,  572, 558,  572, 560,  572, 556,  574, 1684,  576, 1684,  572, 1686,  574, 1686,  572, 1688,  574, 554,  576, 1684,  572, 560,  572, 556,  572, 558,  568, 560,  574, 556,  574, 1684,  576, 1684,  570, 560,  570, 560,  572, 556,  572, 1686,  572, 1686,  574, 1688,  572, 558,  574, 554,  572, 1686,  576, 1684,  572, 1674,  570};  // NEC 61F418E7
uint16_t BTN_NUM_8[67] = {9018, 4524,  572, 556,  574, 1684,  570, 1690,  570, 560,  570, 558,  570, 560,  574, 554,  574, 1684,  574, 1686,  570, 1686,  574, 1686,  570, 1688,  570, 560,  570, 1690,  572, 558,  568, 558,  574, 1688,  570, 558,  570, 1686,  574, 1686,  570, 562,  568, 560,  570, 560,  568, 562,  570, 558,  574, 1684,  570, 560,  570, 558,  568, 1690,  570, 1688,  570, 1690,  572, 1672,  576};  // NEC 61F4B04F
uint16_t BTN_NUM_9[67] = {9052, 4526,  576, 554,  572, 1688,  576, 1686,  572, 560,  570, 560,  572, 558,  574, 556,  572, 1686,  576, 1686,  576, 1684,  574, 1686,  576, 1686,  574, 554,  576, 1686,  572, 558,  570, 560,  572, 1688,  572, 558,  576, 554,  572, 1688,  576, 1686,  574, 556,  574, 556,  574, 558,  572, 556,  574, 1684,  576, 1686,  574, 556,  572, 558,  574, 1686,  572, 1686,  572, 1674,  572};  // NEC 61F49867
uint16_t BTN_NUM_0[67] = {9022, 4520,  574, 554,  570, 1688,  576, 1684,  574, 556,  574, 556,  574, 556,  572, 556,  576, 1684,  572, 1684,  570, 1690,  572, 1686,  574, 1686,  574, 554,  574, 1686,  574, 556,  574, 556,  574, 552,  574, 1684,  576, 1684,  570, 1690,  576, 554,  576, 556,  572, 556,  576, 552,  576, 1684,  576, 554,  576, 554,  574, 554,  576, 1684,  574, 1684,  576, 1682,  570, 1676,  570};  // NEC 61F4708F
uint16_t BTN_NUM_DASH[67] = {9028, 4494,  600, 554,  572, 1686,  572, 1690,  574, 558,  570, 560,  568, 562,  572, 556,  574, 1686,  572, 1686,  574, 1686,  576, 1682,  576, 1686,  570, 556,  574, 1686,  572, 558,  576, 552,  572, 1688,  572, 556,  574, 1686,  574, 556,  574, 556,  574, 556,  574, 1682,  574, 1688,  572, 556,  572, 1688,  572, 556,  576, 1684,  576, 1682,  572, 1688,  576, 556,  572, 544,  572};  // NEC 61F4A35C
uint16_t BTN_NUM_ENTER[67] = {9032, 4516,  576, 556,  574, 1684,  576, 1686,  576, 554,  574, 556,  574, 556,  574, 556,  574, 1684,  574, 1686,  574, 1686,  572, 1686,  574, 1686,  576, 554,  572, 1688,  570, 560,  574, 556,  574, 1684,  572, 1688,  572, 558,  574, 556,  574, 554,  572, 558,  574, 556,  576, 554,  574, 556,  574, 554,  574, 1684,  572, 1686,  574, 1686,  574, 1686,  576, 1684,  574, 1674,  572};  // NEC 61F4C03F

uint16_t BTN_VOL_UP[67] = {9022, 4504,  594, 558,  572, 1686,  574, 1688,  570, 562,  568, 562,  568, 562,  574, 552,  568, 1690,  572, 1688,  574, 1686,  574, 1686,  570, 1692,  570, 558,  568, 1692,  570, 560,  568, 562,  570, 558,  572, 1688,  570, 558,  568, 1690,  568, 1690,  570, 1692,  570, 560,  572, 558,  572, 1690,  576, 554,  570, 1690,  574, 556,  568, 562,  576, 554,  568, 1690,  572, 1674,  572};  // NEC 61F45CA3
uint16_t BTN_VOL_DOWN[67] = {9050, 4520,  574, 556,  576, 1684,  572, 1688,  572, 558,  572, 558,  574, 556,  568, 560,  570, 1690,  572, 1688,  572, 1688,  570, 1690,  570, 1692,  570, 560,  568, 1692,  568, 562,  570, 560,  568, 560,  568, 1692,  576, 554,  570, 1688,  570, 1690,  572, 1690,  574, 556,  570, 558,  570, 1690,  574, 556,  570, 1692,  574, 558,  570, 560,  576, 554,  568, 1690,  570, 1678,  568};  // NEC 61F45CA3
uint16_t BTN_VOL_MUTE[67] = {9028, 4518,  572, 558,  572, 1686,  576, 1684,  572, 560,  570, 558,  570, 560,  572, 556,  572, 1688,  572, 1688,  576, 1684,  572, 1686,  572, 1688,  574, 556,  570, 1690,  572, 560,  568, 562,  570, 556,  572, 1688,  576, 556,  572, 1686,  576, 1686,  570, 1690,  572, 560,  570, 558,  570, 1690,  572, 556,  576, 1686,  570, 560,  570, 560,  570, 558,  572, 1688,  574, 1672,  576};  // NEC 61F45CA3
uint16_t BTN_CHAN_UP[67] = {9048, 4516,  574, 560,  568, 1690,  574, 1688,  568, 560,  576, 556,  572, 558,  566, 560,  570, 1688,  570, 1690,  568, 1688,  570, 1688,  570, 1690,  576, 554,  574, 1686,  568, 562,  572, 556,  570, 1688,  572, 1688,  568, 1690,  574, 558,  570, 560,  570, 562,  574, 556,  574, 554,  568, 564,  572, 556,  568, 558,  572, 1686,  570, 1688,  570, 1688,  576, 1684,  570, 1676,  572};  // NEC 61F4E01F
uint16_t BTN_CHAN_DOWN[67] = {9036, 4514,  574, 566,  568, 1688,  570, 1692,  566, 564,  572, 558,  566, 564,  566, 564,  564, 1694,  568, 1692,  572, 1688,  568, 1690,  570, 1692,  568, 562,  570, 1688,  570, 562,  568, 562,  568, 1690,  570, 562,  566, 564,  568, 562,  568, 562,  566, 564,  566, 564,  566, 564,  566, 564,  566, 1690,  572, 1688,  566, 1694,  570, 1688,  568, 1690,  570, 1690,  572, 1674,  570};  // NEC 61F4807F

uint16_t BTN_SEL_GUIDE[67] = {9050, 4514,  574, 558,  572, 1686,  570, 1690,  572, 560,  570, 560,  574, 554,  570, 560,  570, 1688,  570, 1690,  574, 1684,  570, 1690,  570, 1690,  572, 558,  568, 1692,  570, 562,  570, 560,  568, 564,  572, 556,  572, 1684,  570, 1690,  572, 1690,  572, 560,  570, 558,  572, 1686,  572, 1688,  570, 1688,  572, 560,  572, 560,  576, 552,  568, 1688,  574, 1688,  574, 542,  570};  // NEC 61F439C6
uint16_t BTN_SEL_ACTIVE[67] = {9022, 4522,  572, 558,  572, 1686,  574, 1686,  568, 560,  570, 560,  568, 560,  572, 558,  572, 1686,  570, 1688,  570, 1690,  572, 1686,  568, 1690,  576, 554,  576, 1686,  568, 562,  570, 558,  570, 1690,  570, 1690,  570, 562,  570, 558,  570, 1692,  568, 562,  570, 558,  572, 1688,  568, 562,  576, 552,  574, 1686,  570, 1690,  572, 556,  572, 1686,  570, 1690,  568, 548,  572};  // NEC 61F4C936
uint16_t BTN_SEL_LIST[67] = {9028, 4498,  590, 560,  574, 1686,  572, 1690,  574, 556,  568, 562,  570, 560,  574, 554,  570, 1688,  570, 1690,  572, 1688,  574, 1686,  568, 1692,  576, 554,  570, 1692,  570, 560,  574, 556,  572, 1688,  576, 554,  572, 1690,  570, 560,  574, 1688,  574, 558,  576, 554,  576, 554,  568, 560,  572, 1690,  572, 558,  570, 1692,  570, 560,  572, 1686,  574, 1686,  572, 1676,  572};  // NEC 61F4A857
uint16_t BTN_SEL_EXIT[67] = {9024, 4524,  572, 558,  572, 1686,  576, 1686,  570, 560,  572, 558,  574, 556,  574, 556,  570, 1688,  576, 1684,  570, 1688,  572, 1688,  576, 1686,  572, 556,  576, 1684,  572, 558,  570, 558,  574, 1686,  574, 554,  568, 1692,  572, 558,  574, 554,  570, 1690,  574, 556,  570, 560,  570, 558,  576, 1686,  570, 558,  568, 1690,  574, 1686,  568, 560,  572, 1688,  572, 1674,  572};  // NEC 61F4A45B
uint16_t BTN_SEL_UP[67] = {9030, 4518,  572, 558,  570, 1688,  570, 1692,  568, 562,  576, 554,  568, 562,  576, 554,  574, 1686,  572, 1686,  572, 1688,  572, 1686,  570, 1692,  570, 558,  572, 1690,  570, 560,  572, 556,  572, 1688,  568, 1692,  570, 560,  572, 1688,  570, 560,  570, 562,  570, 558,  570, 1692,  570, 562,  570, 560,  572, 1690,  568, 560,  568, 1690,  570, 1690,  570, 1692,  570, 546,  572};  // NEC 61F4D12E
uint16_t BTN_SEL_RIGHT[67] = {9030, 4512,  574, 562,  570, 1688,  570, 1688,  570, 564,  572, 558,  568, 562,  574, 554,  572, 1686,  568, 1688,  570, 1690,  572, 1688,  572, 1688,  568, 564,  566, 1690,  568, 562,  566, 562,  570, 1690,  572, 560,  568, 1686,  570, 1690,  572, 1690,  568, 562,  574, 556,  566, 1692,  568, 564,  568, 1690,  574, 556,  568, 562,  566, 562,  570, 1688,  568, 1692,  570, 548,  570};  // NEC 61F4B946
uint16_t BTN_SEL_DOWN[67] = {9054, 4516,  576, 556,  572, 1686,  572, 1690,  576, 556,  570, 560,  570, 560,  572, 558,  570, 1690,  568, 1688,  574, 1686,  570, 1688,  574, 1686,  572, 558,  568, 1690,  574, 560,  570, 558,  568, 1692,  578, 554,  570, 562,  568, 560,  568, 1692,  576, 556,  568, 560,  572, 1688,  576, 554,  568, 1690,  570, 1690,  572, 1690,  574, 556,  568, 1690,  570, 1692,  574, 544,  572};  // NEC 61F48976
uint16_t BTN_SEL_LEFT[67] = {9028, 4522,  574, 558,  576, 1684,  572, 1688,  576, 556,  568, 560,  572, 560,  568, 558,  570, 1688,  578, 1682,  572, 1688,  570, 1688,  574, 1690,  576, 554,  572, 1688,  576, 556,  574, 554,  570, 562,  574, 556,  572, 556,  572, 1690,  570, 562,  574, 556,  574, 556,  570, 1686,  576, 1686,  570, 1688,  576, 1686,  570, 560,  574, 1684,  570, 1690,  576, 1682,  576, 544,  572};  // NEC 61F411EE
uint16_t BTN_SEL_SELECT[67] = {9030, 4516,  578, 554,  572, 1686,  570, 1690,  568, 562,  574, 554,  570, 560,  568, 560,  568, 1688,  576, 1684,  570, 1688,  572, 1686,  574, 1686,  574, 556,  572, 1686,  572, 560,  574, 556,  572, 556,  570, 560,  574, 556,  574, 552,  572, 1688,  570, 562,  568, 562,  568, 560,  568, 1690,  570, 1688,  570, 1688,  570, 1690,  576, 552,  574, 1686,  570, 1688,  574, 1672,  572};  // NEC 61F408F7
uint16_t BTN_SEL_PREV[67] = {9036, 4516,  578, 558,  568, 1690,  574, 1688,  572, 560,  568, 562,  566, 566,  568, 560,  566, 1692,  566, 1692,  570, 1690,  574, 1686,  568, 1694,  572, 560,  568, 1690,  570, 560,  570, 560,  566, 1694,  570, 560,  568, 1690,  568, 564,  566, 564,  570, 560,  566, 1692,  570, 566,  568, 560,  568, 1690,  574, 554,  568, 1690,  568, 1692,  568, 1692,  568, 564,  568, 1676,  572};  // NEC 61F4A25D
uint16_t BTN_SEL_RECORD[67] = {9028, 4520,  578, 558,  576, 1684,  572, 1690,  570, 560,  568, 562,  570, 562,  568, 558,  570, 1692,  568, 1690,  574, 1686,  572, 1690,  574, 1686,  572, 560,  570, 1692,  574, 558,  572, 556,  570, 1692,  570, 1684,  570, 1692,  570, 1688,  570, 1692,  572, 560,  572, 558,  572, 558,  574, 556,  574, 558,  568, 562,  568, 564,  568, 560,  568, 1690,  576, 1686,  568, 1678,  570};  // NEC 61F4F807
uint16_t BTN_SEL_INFO[67] = {9028, 4520,  576, 560,  568, 1688,  574, 1688,  568, 566,  564, 564,  566, 564,  566, 562,  566, 1692,  572, 1686,  572, 1690,  568, 1690,  570, 1690,  570, 560,  566, 1696,  566, 564,  570, 560,  566, 1692,  570, 1690,  568, 1690,  570, 1692,  568, 562,  566, 564,  570, 558,  572, 1688,  570, 562,  568, 562,  570, 560,  570, 560,  570, 1686,  574, 1688,  574, 1686,  570, 548,  572};  // NEC 61F4F10E

uint16_t BTN_SEL_ONDEMAND[67] = {9026, 4518,  578, 554,  570, 1684,  574, 1688,  576, 554,  568, 562,  574, 554,  574, 554,  570, 1688,  570, 1690,  572, 1686,  572, 1686,  576, 1686,  572, 558,  570, 1690,  570, 560,  568, 560,  570, 1688,  578, 554,  570, 1688,  574, 556,  570, 1688,  572, 1688,  576, 554,  572, 1686,  576, 556,  570, 1686,  570, 562,  568, 1690,  570, 562,  574, 554,  568, 1690,  578, 542,  574};  // NEC 61F4AD52

uint16_t BTN_PVR_STOP[67] = {9028, 4518,  574, 562,  572, 1684,  572, 1690,  568, 562,  568, 562,  570, 560,  570, 560,  570, 1686,  568, 1688,  574, 1686,  572, 1688,  568, 1688,  572, 558,  568, 1692,  568, 562,  568, 560,  572, 1688,  568, 560,  568, 1690,  574, 556,  572, 1686,  568, 1692,  570, 562,  566, 564,  566, 564,  568, 1688,  572, 558,  572, 1690,  570, 560,  568, 560,  568, 1688,  576, 1670,  576};  // NEC 61F4AC53
uint16_t BTN_PVR_R[67] = {9028, 4518,  576, 558,  574, 1686,  570, 1690,  568, 564,  568, 560,  570, 562,  566, 562,  566, 1690,  574, 1684,  572, 1686,  570, 1688,  572, 1692,  570, 560,  568, 1688,  570, 562,  568, 560,  572, 1686,  572, 558,  572, 1688,  576, 552,  570, 1688,  568, 562,  568, 1688,  572, 1688,  568, 560,  570, 1692,  574, 554,  566, 1690,  570, 564,  566, 1692,  570, 562,  566, 548,  576};  // NEC 61F4AB54
uint16_t BTN_PVR_REWIND[67] = {9028, 4518,  574, 556,  568, 1690,  572, 1688,  576, 556,  572, 558,  570, 560,  570, 560,  570, 1686,  572, 1688,  572, 1686,  570, 1690,  572, 1690,  570, 560,  574, 1688,  572, 558,  568, 560,  568, 1692,  572, 556,  572, 1690,  568, 560,  572, 1690,  574, 554,  574, 556,  574, 1688,  576, 552,  572, 1688,  574, 556,  568, 1692,  568, 562,  570, 1688,  572, 1688,  574, 542,  572};  // NEC 61F4A956
uint16_t BTN_PVR_PLAYPAUSE[67] = {9034, 4514,  574, 560,  566, 1692,  568, 1692,  568, 562,  566, 564,  566, 564,  570, 558,  570, 1688,  568, 1690,  572, 1688,  568, 1688,  574, 1688,  572, 560,  568, 1692,  566, 566,  570, 558,  568, 1692,  568, 562,  568, 1692,  568, 564,  570, 560,  566, 1694,  574, 556,  566, 1692,  566, 564,  568, 1690,  570, 560,  566, 1690,  572, 1688,  566, 564,  570, 1688,  570, 548,  566};  // NEC 61F4A55A
uint16_t BTN_PVR_FASTFORWARD[67] = {9034, 4514,  580, 554,  576, 1682,  572, 1686,  572, 562,  570, 560,  568, 560,  572, 558,  570, 1690,  570, 1690,  570, 1688,  572, 1690,  572, 1688,  576, 556,  572, 1686,  576, 556,  570, 558,  570, 1692,  570, 560,  568, 1692,  576, 554,  568, 1690,  570, 560,  572, 1686,  570, 560,  576, 554,  568, 1692,  570, 560,  572, 1688,  572, 558,  568, 1692,  572, 558,  570, 1674,  576};  // NEC 61F4AA55
uint16_t BTN_PVR_REPEAT[67] = {9056, 4524,  576, 556,  574, 1686,  576, 1686,  576, 556,  572, 560,  568, 562,  574, 556,  574, 1688,  570, 1690,  570, 1692,  572, 1688,  570, 1692,  574, 556,  572, 1688,  576, 556,  572, 558,  568, 1692,  570, 560,  576, 1684,  572, 560,  572, 558,  574, 1686,  570, 1692,  570, 562,  574, 556,  568, 1692,  574, 556,  570, 1688,  572, 1692,  574, 556,  576, 554,  570, 1678,  570};  // NEC 61F4A659
uint16_t BTN_PVR_NEXT[67] = {9052, 4518,  570, 560,  574, 1686,  572, 1688,  570, 560,  568, 562,  570, 560,  570, 560,  572, 1686,  576, 1684,  570, 1690,  570, 1688,  572, 1690,  570, 558,  572, 1690,  570, 560,  570, 558,  572, 1688,  572, 556,  570, 1692,  574, 556,  570, 560,  568, 1690,  570, 1690,  572, 1690,  570, 558,  568, 1692,  570, 558,  572, 1688,  570, 1692,  572, 558,  570, 560,  570, 546,  572};  // NEC 61F4A758

uint16_t BTN_PWR_ON[67] = {9028, 4518,  574, 560,  568, 1690,  570, 1690,  572, 562,  570, 562,  574, 556,  570, 560,  568, 1690,  570, 1688,  574, 1684,  574, 1686,  574, 1688,  572, 558,  572, 1686,  572, 562,  570, 560,  568, 560,  568, 1690,  572, 1688,  572, 1688,  572, 558,  574, 1686,  572, 558,  568, 1692,  572, 1688,  570, 562,  570, 560,  568, 560,  568, 1692,  568, 560,  568, 1692,  568, 548,  568};  // NEC 61F4758A
uint16_t BTN_PWR_OFF[67] = {9028, 4518,  574, 562,  572, 1688,  568, 1692,  576, 554,  568, 562,  570, 566,  564, 558,  570, 1690,  568, 1690,  574, 1686,  572, 1686,  568, 1694,  566, 562,  572, 1686,  570, 560,  570, 560,  574, 554,  568, 1690,  568, 1692,  566, 1692,  570, 560,  574, 1684,  570, 1692,  570, 560,  572, 1688,  570, 562,  566, 564,  566, 562,  566, 1692,  572, 560,  566, 562,  570, 1674,  572};  // NEC 61F47689
uint16_t BTN_MENU[67] = {9046, 4524,  570, 560,  574, 1686,  572, 1688,  572, 558,  568, 562,  570, 560,  568, 560,  570, 1690,  572, 1686,  572, 1688,  568, 1690,  574, 1686,  570, 560,  572, 1688,  572, 556,  576, 554,  570, 560,  570, 1690,  568, 562,  570, 560,  572, 560,  570, 560,  576, 552,  572, 1686,  574, 1688,  570, 558,  574, 1686,  570, 1690,  572, 1688,  568, 1690,  568, 1692,  576, 540,  570};  // NEC 61F441BE

//
uint16_t BTN_MATRIX_OUTPUTA_INPUT1[67] = {9260, 4542,  570, 596,  552, 582,  568, 598,  552, 598,  552, 598,  552, 598,  550, 598,  552, 1734,  552, 1732,  554, 1732,  552, 1716,  570, 1716,  568, 1734,  552, 1716,  570, 1732,  554, 596,  552, 598,  552, 1732,  554, 596,  550, 598,  552, 1716,  568, 598,  552, 600,  550, 580,  570, 1716,  568, 598,  552, 1716,  570, 1734,  552, 596,  554, 1732,  552, 1732,  552, 1716,  570};  // NEC 1FE48B7
uint16_t BTN_MATRIX_OUTPUTA_INPUT2[67] = {9226, 4556,  554, 598,  550, 596,  552, 596,  550, 596,  552, 596,  552, 598,  550, 594,  552, 1714,  570, 1732,  552, 1730,  552, 1732,  552, 1732,  550, 1732,  552, 1732,  552, 1732,  554, 596,  552, 596,  550, 1732,  552, 596,  550, 1732,  552, 1732,  552, 598,  550, 598,  550, 598,  550, 1732,  552, 598,  552, 1732,  550, 596,  552, 596,  552, 1730,  554, 1732,  552, 1732,  552};  // NEC 1FE58A7
uint16_t BTN_MATRIX_OUTPUTA_INPUT3[67] = {9238, 4540,  566, 598,  548, 598,  548, 596,  550, 596,  548, 598,  548, 596,  550, 596,  550, 1730,  550, 1732,  550, 1732,  548, 1732,  550, 1732,  550, 1730,  552, 1732,  550, 1732,  548, 596,  550, 596,  550, 1734,  548, 1734,  548, 1716,  566, 1732,  550, 596,  550, 598,  550, 594,  552, 1730,  554, 596,  550, 596,  552, 596,  550, 596,  550, 1732,  550, 1716,  568, 1734,  548};  // NEC 1FE7887
uint16_t BTN_MATRIX_OUTPUTA_INPUT4[67] = {9218, 4556,  550, 594,  550, 596,  548, 596,  550, 598,  546, 596,  548, 598,  546, 596,  550, 1714,  566, 1730,  548, 1730,  550, 1732,  550, 1730,  548, 1732,  548, 1730,  550, 1730,  550, 596,  548, 1732,  550, 1730,  548, 596,  550, 594,  552, 580,  564, 596,  550, 596,  550, 596,  550, 596,  550, 598,  548, 1732,  548, 1732,  548, 1714,  566, 1732,  548, 1730,  550, 1732,  546};  // NEC 1FEC03F
uint16_t BTN_MATRIX_OUTPUTA_INPUTL[67] = {9284, 4512,  598, 552,  594, 568,  580, 552,  594, 552,  596, 564,  582, 568,  578, 552,  594, 1688,  594, 1700,  580, 1702,  580, 1686,  594, 1686,  596, 1702,  580, 1702,  578, 1702,  578, 552,  594, 1686,  594, 552,  594, 552,  594, 552,  594, 566,  578, 552,  594, 566,  578, 566,  580, 564,  580, 1702,  578, 1706,  574, 1686,  594, 1706,  576, 1684,  594, 1686,  594, 1702,  580};  // NEC 1FE807F
uint16_t BTN_MATRIX_OUTPUTA_INPUTR[67] = {9224, 4560,  550, 598,  548, 596,  548, 596,  550, 582,  564, 598,  548, 582,  566, 598,  548, 1732,  548, 1732,  552, 1732,  548, 1732,  550, 1734,  550, 1734,  548, 1732,  550, 1732,  550, 598,  548, 596,  548, 1734,  550, 596,  550, 598,  548, 596,  550, 596,  548, 600,  548, 598,  550, 1716,  566, 580,  564, 1734,  548, 1718,  564, 1734,  548, 1732,  550, 1732,  550, 1732,  550};  // NEC 1FE40BF

uint16_t BTN_MATRIX_OUTPUTB_INPUT1[67] = {9216, 4556,  550, 580,  564, 598,  548, 594,  550, 596,  546, 598,  548, 596,  548, 596,  550, 1732,  550, 1730,  548, 1730,  548, 1730,  550, 1730,  550, 1714,  564, 1732,  548, 1730,  548, 594,  550, 1716,  564, 1716,  564, 1732,  548, 596,  548, 596,  548, 598,  546, 596,  548, 598,  546, 596,  548, 598,  546, 580,  564, 1734,  548, 1714,  564, 1730,  548, 1732,  550, 1730,  548};  // NEC 1FEE01F
uint16_t BTN_MATRIX_OUTPUTB_INPUT2[67] = {9200, 4558,  550, 596,  548, 582,  562, 598,  548, 598,  546, 582,  562, 598,  548, 596,  550, 1716,  566, 1722,  560, 1716,  564, 1732,  548, 1716,  564, 1732,  550, 1716,  564, 1718,  562, 598,  548, 596,  548, 580,  564, 598,  548, 1732,  550, 596,  548, 596,  548, 596,  548, 598,  548, 1732,  548, 1732,  550, 1732,  550, 596,  548, 1732,  550, 1730,  548, 1734,  548, 1732,  546};  // NEC 1FE10EF
uint16_t BTN_MATRIX_OUTPUTB_INPUT3[67] = {9208, 4540,  566, 598,  546, 596,  550, 598,  548, 596,  548, 596,  548, 598,  546, 580,  564, 1730,  548, 1732,  548, 1716,  564, 1730,  550, 1716,  564, 1716,  564, 1732,  546, 1732,  550, 596,  546, 1732,  548, 580,  564, 596,  548, 1716,  564, 580,  564, 580,  564, 580,  562, 580,  564, 598,  548, 1732,  548, 1732,  550, 580,  564, 1732,  546, 1716,  562, 1716,  566, 1714,  564};  // NEC 1FE906F
uint16_t BTN_MATRIX_OUTPUTB_INPUT4[67] = {9186, 4558,  550, 594,  550, 594,  550, 578,  566, 594,  574, 570,  576, 568,  578, 568,  576, 1702,  550, 1732,  548, 1730,  576, 1690,  588, 1704,  564, 1718,  574, 1706,  548, 1730,  550, 594,  548, 1730,  550, 1730,  550, 1730,  548, 1730,  550, 1732,  548, 592,  550, 594,  550, 578,  566, 594,  550, 596,  548, 594,  548, 596,  548, 578,  566, 1730,  550, 1730,  550, 1730,  574};  // NEC 1FEF807
uint16_t BTN_MATRIX_OUTPUTB_INPUTL[67] = {9204, 4518,  564, 580,  564, 580,  562, 582,  562, 582,  560, 582,  564, 582,  560, 582,  562, 1718,  564, 1716,  560, 1718,  562, 1734,  548, 1728,  550, 1716,  562, 1716,  562, 1716,  564, 580,  560, 582,  562, 1716,  562, 582,  586, 1694,  560, 582,  562, 582,  588, 554,  562, 582,  564, 1716,  564, 580,  564, 1714,  566, 580,  562, 1718,  562, 1718,  562, 1716,  562, 1732,  548};  // NEC 1FE50AF
uint16_t BTN_MATRIX_OUTPUTB_INPUTR[67] = {9236, 4530,  550, 594,  550, 596,  546, 580,  566, 594,  550, 596,  578, 568,  550, 596,  576, 1714,  576, 1716,  550, 1732,  544, 1732,  548, 1732,  548, 1730,  546, 1734,  544, 1736,  546, 596,  546, 1736,  546, 1730,  548, 596,  550, 1738,  548, 1732,  550, 598,  544, 598,  550, 576,  566, 598,  546, 596,  548, 1730,  548, 596,  550, 592,  550, 1732,  550, 1728,  552, 1730,  550};  // NEC 1FED827


std::map<uint32_t, String> m_hexToButtonMap = {
// RCU buttons
  { 0x61F440BF, "BTN_NUM_1" },
  { 0x61F4C837, "BTN_NUM_2" },
  { 0x61F430CF, "BTN_NUM_3" },
  { 0x61F46897, "BTN_NUM_4" },
  { 0x61F428D7, "BTN_NUM_5" },
  { 0x61F4E817, "BTN_NUM_6" },
  { 0x61F418E7, "BTN_NUM_7" },
  { 0x61F4B04F, "BTN_NUM_8" },
  { 0x61F49867, "BTN_NUM_9" },
  { 0x61F4708F, "BTN_NUM_0" },
  { 0x61F4A35C, "BTN_NUM_DASH" },
  { 0x61F4C03F, "BTN_NUM_ENTER" },

  { 0x61F45CA3, "BTN_VOL_UP" },
  { 0x61F45CA3, "BTN_VOL_DOWN" },
  { 0x61F45CA3, "BTN_VOL_MUTE" },
  { 0x61F4E01F, "BTN_CHAN_UP" },
  { 0x61F4807F, "BTN_CHAN_DOWN" },

  { 0x61F439C6, "BTN_SEL_GUIDE" },
  { 0x61F4C936, "BTN_SEL_ACTIVE" },
  { 0x61F4A857, "BTN_SEL_LIST" },
  { 0x61F4A45B, "BTN_SEL_EXIT" },
  { 0x61F4D12E, "BTN_SEL_UP" },
  { 0x61F4B946, "BTN_SEL_RIGHT" },
  { 0x61F48976, "BTN_SEL_DOWN" },
  { 0x61F411EE, "BTN_SEL_LEFT" },
  { 0x61F408F7, "BTN_SEL_SELECT" },
  { 0x61F4A25D, "BTN_SEL_PREV" },
  { 0x61F4F807, "BTN_SEL_RECORD" },
  { 0x61F4F10E, "BTN_SEL_INFO" },

  { 0x61F4AD52, "BTN_SEL_ONDEMAND" },

  { 0x61F4AC53, "BTN_PVR_STOP" },
  { 0x61F4AB54, "BTN_PVR_R" },
  { 0x61F4A956, "BTN_PVR_REWIND" },
  { 0x61F4A55A, "BTN_PVR_PLAYPAUSE" },
  { 0x61F4AA55, "BTN_PVR_FASTFORWARD" },
  { 0x61F4A659, "BTN_PVR_REPEAT" },
  { 0x61F4A758, "BTN_PVR_NEXT" },

  { 0x61F4758A, "BTN_PWR_ON" },
  { 0x61F47689, "BTN_PWR_OFF" },
  { 0x61F441BE, "BTN_MENU" },

// HDMI matrix buttons
  { 0x1FE48B7, "BTN_MATRIX_OUTPUTA_INPUT1" },
  { 0x1FE58A7, "BTN_MATRIX_OUTPUTA_INPUT2" },
  { 0x1FE7887, "BTN_MATRIX_OUTPUTA_INPUT3" },
  { 0x1FEC03F, "BTN_MATRIX_OUTPUTA_INPUT4" },
  { 0x1FE807F, "BTN_MATRIX_OUTPUTA_INPUTL" },
  { 0x1FE40BF, "BTN_MATRIX_OUTPUTA_INPUTR" },

  { 0x1FEE01F, "BTN_MATRIX_OUTPUTB_INPUT1" },
  { 0x1FE10EF, "BTN_MATRIX_OUTPUTB_INPUT2" },
  { 0x1FE906F, "BTN_MATRIX_OUTPUTB_INPUT3" },
  { 0x1FEF807, "BTN_MATRIX_OUTPUTB_INPUT4" },
  { 0x1FE50AF, "BTN_MATRIX_OUTPUTB_INPUTL" },
  { 0x1FED827, "BTN_MATRIX_OUTPUTB_INPUTR" }
};

std::map<String, uint16_t *> m_nameToArrayMap = {
// RCU buttons
  { "BTN_NUM_1", BTN_NUM_1 },
  { "BTN_NUM_2", BTN_NUM_2 },
  { "BTN_NUM_3", BTN_NUM_3 },
  { "BTN_NUM_4", BTN_NUM_4 },
  { "BTN_NUM_5", BTN_NUM_5 },
  { "BTN_NUM_6", BTN_NUM_6 },
  { "BTN_NUM_7", BTN_NUM_7 },
  { "BTN_NUM_8", BTN_NUM_8 },
  { "BTN_NUM_9", BTN_NUM_9 },
  { "BTN_NUM_0", BTN_NUM_0 },
  { "BTN_NUM_DASH", BTN_NUM_DASH },
  { "BTN_NUM_ENTER", BTN_NUM_ENTER },

  { "BTN_VOL_UP", BTN_VOL_UP },
  { "BTN_VOL_DOWN", BTN_VOL_DOWN },
  { "BTN_VOL_MUTE", BTN_VOL_MUTE },
  { "BTN_CHAN_UP", BTN_CHAN_UP },
  { "BTN_CHAN_DOWN", BTN_CHAN_DOWN },

  { "BTN_SEL_GUIDE", BTN_SEL_GUIDE },
  { "BTN_SEL_ACTIVE", BTN_SEL_ACTIVE },
  { "BTN_SEL_LIST", BTN_SEL_LIST },
  { "BTN_SEL_EXIT", BTN_SEL_EXIT },
  { "BTN_SEL_UP", BTN_SEL_UP },
  { "BTN_SEL_RIGHT", BTN_SEL_RIGHT },
  { "BTN_SEL_DOWN", BTN_SEL_DOWN },
  { "BTN_SEL_LEFT", BTN_SEL_LEFT },
  { "BTN_SEL_SELECT", BTN_SEL_SELECT },
  { "BTN_SEL_PREV", BTN_SEL_PREV },
  { "BTN_SEL_RECORD", BTN_SEL_RECORD },
  { "BTN_SEL_INFO", BTN_SEL_INFO },

  { "BTN_SEL_ONDEMAND", BTN_SEL_ONDEMAND },

  { "BTN_PVR_STOP", BTN_PVR_STOP },
  { "BTN_PVR_R", BTN_PVR_R },
  { "BTN_PVR_REWIND", BTN_PVR_REWIND },
  { "BTN_PVR_PLAYPAUSE", BTN_PVR_PLAYPAUSE },
  { "BTN_PVR_FASTFORWARD", BTN_PVR_FASTFORWARD },
  { "BTN_PVR_REPEAT", BTN_PVR_REPEAT },
  { "BTN_PVR_NEXT", BTN_PVR_NEXT },

  { "BTN_PWR_ON", BTN_PWR_ON },
  { "BTN_PWR_OFF", BTN_PWR_OFF },
  { "BTN_MENU", BTN_MENU },

// HDMI matrix buttons
  { "BTN_MATRIX_OUTPUTA_INPUT1", BTN_MATRIX_OUTPUTA_INPUT1 },
  { "BTN_MATRIX_OUTPUTA_INPUT2", BTN_MATRIX_OUTPUTA_INPUT2 },
  { "BTN_MATRIX_OUTPUTA_INPUT3", BTN_MATRIX_OUTPUTA_INPUT3 },
  { "BTN_MATRIX_OUTPUTA_INPUT4", BTN_MATRIX_OUTPUTA_INPUT4 },
  { "BTN_MATRIX_OUTPUTA_INPUTL", BTN_MATRIX_OUTPUTA_INPUTL },
  { "BTN_MATRIX_OUTPUTA_INPUTR", BTN_MATRIX_OUTPUTA_INPUTR },
  
  { "BTN_MATRIX_OUTPUTB_INPUT1", BTN_MATRIX_OUTPUTB_INPUT1 },
  { "BTN_MATRIX_OUTPUTB_INPUT2", BTN_MATRIX_OUTPUTB_INPUT2 },
  { "BTN_MATRIX_OUTPUTB_INPUT3", BTN_MATRIX_OUTPUTB_INPUT3 },
  { "BTN_MATRIX_OUTPUTB_INPUT4", BTN_MATRIX_OUTPUTB_INPUT4 },
  { "BTN_MATRIX_OUTPUTB_INPUTL", BTN_MATRIX_OUTPUTB_INPUTL },
  { "BTN_MATRIX_OUTPUTB_INPUTR", BTN_MATRIX_OUTPUTB_INPUTR }
};

void handleRecord() {
  String output = "";
  if (irrecv.decode(&results)) {
    output += resultToHexidecimal(&results);
    irrecv.resume();  // Receive the next value

    uint32_t intValue = (uint32_t)strtol(output.c_str(), 0, 16);
    Serial.print(output);
    Serial.print(" : ");

    std::map<uint32_t, String>::iterator it;
    it = m_hexToButtonMap.find(intValue);

    if (it != m_hexToButtonMap.end())
    {
      Serial.print(it->second);
      Serial.println(" pressed!");
    }
    else
    {
      Serial.println("Button unrecognized!");
    }
  } 
  else {
    //output = "empty";
  } 
}

void setup()
{    
    Serial.begin(115200);
    delay(10);
    if (!m_bReadFromSerial)
    {
        Serial.println("\nInitialized");
    }

    irrecv.enableIRIn();  // Start the receiver
    irsend.begin(); // Start IR sender

    m_timer = new TimerMgr();
    //m_server = new ServerMgr("10.100.96.49", 3000, "");

    if (!m_bReadFromSerial)
    {
        m_server = new ServerMgr("192.168.43.76", 3000, "/status");
    }
    else
    {
        Serial.flush();
    }
}

void SendSensorValue(float value)
{  
  //StaticJsonBuffer<200> jsonBuffer;
  //JsonObject& root = jsonBuffer.createObject();
  
  //root["Red"] = value/100;
  
  //m_server->sendRequest(root, sensorCallback);
}

void sensorCallback()
{
    Serial.println("Returned from request!");
}

String command;
void loop()
{
    //
    if (m_bSend)
    {
        handleSend(m_bReadFromSerial);
    }
    else
    {
        handleRecord();
    }
  
    //m_server->receivedResponce();

    m_timer->tickTimers();

    //delay(1000);
}

bool bMakingRequest = false;

void handleSend(bool bUseSerial)
{
    bool bCommandReady = false;
    
    if (bUseSerial)
    {
        if (Serial.available() > 0)
        {
            char currentLetter = Serial.read();
            bCommandReady = currentLetter == '\0';
           
            if (bCommandReady)
            {
              Serial.println();
            }
            else
            {
              command.concat(currentLetter);
              Serial.print(currentLetter);
            }
        }
    }
    else if (m_server->m_bReady)
    {
        HTTPClient http;

        Serial.print("[HTTP] begin...\n");
        String endpoint = m_server->m_host + ":" + m_server->m_httpPort + m_server->m_endpoint;
        
        if (http.begin(m_server->client, "http://192.168.43.76:3000/status")) {  // HTTP
    
          Serial.print("[HTTP] GET...\n");
          // start connection and send HTTP header
          int httpCode = http.GET();
    
          // httpCode will be negative on error
          if (httpCode > 0) {
            // HTTP header has been send and Server response header has been handled
            Serial.printf("[HTTP] GET... code: %d\n", httpCode);
    
            // file found at server
            if (httpCode == HTTP_CODE_OK || httpCode == HTTP_CODE_MOVED_PERMANENTLY) {
              String payload = http.getString();
              command = payload;
              bCommandReady = command != "";
              Serial.println(payload);
            }
          } else {
            Serial.printf("[HTTP] GET... failed, error: %s\n", http.errorToString(httpCode).c_str());
          }
    
          http.end();
          delay(50);
        } else {
          Serial.printf("[HTTP} Unable to connect\n");
        }
    }

    if (bCommandReady)
    {
        auto it = m_nameToArrayMap.find(command);
        if (it != m_nameToArrayMap.end())
        {
            irsend.sendRaw(it->second, 67, 38); // 38 = kHz
        }

        command = "";
    }
}
